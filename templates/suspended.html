<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الطلبات المعلقة - سبونج إي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>
    <style>
        :root {
            /* نظام الألوان المخصص للحالات */
            --color-accounted: #87CEEB; /* تم محاسبة - ازرق فاتح */
            --color-mandob-accounted: #191970; /* تم محاسبة المندوب - نيلي غامق */
            --color-customer-accounted: #6495ED; /* تم محاسبة العميل - نيلي فاتح */
            --color-delivered: #28a745; /* تم التسليم - اخضر */
            --color-rejected: #B22222; /* رفض - احمر غامق قليلا */
            --color-partial-return: #FFB6C1; /* راجع جزئي - احمر فاتح */
            --color-delayed: #FFA500; /* مؤجل - برتقالي */
            --color-in-progress: #FFD700; /* قيد التنفيذ - اصفر */
            --color-unconfirmed: #708090; /* غير مؤكد - رصاصي */
            --color-partial-return-yellow: #FF6347; /* راجع جزئي - احمر مع اصفرار */
            --color-partial-delivered: #006400; /* واصل جزئي - اخضر غامق */
            
            /* ألوان التصميم العام */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255,255,255,0.95);
            --glass-effect: rgba(255,255,255,0.1);
        }
        
        body {
            background: var(--primary-gradient);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        
        /* تحسينات للهواتف المحمولة */
        @media (max-width: 768px) {
            body {
                font-size: 12px;
            }
            
            .container-fluid {
                padding: 10px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .table-responsive {
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .badge {
                font-size: 0.7em;
                padding: 4px 8px;
            }
            
            .suspension-reason {
                font-size: 0.7em;
            }
            
            .btn-group-vertical .btn {
                font-size: 10px;
                padding: 2px 5px;
            }
        }
        
        /* تصميم البطاقات الحديث */
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(15px);
            background: var(--card-bg);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        /* شريط التنقل المحسن */
        .navbar {
            background: var(--card-bg) !important;
            backdrop-filter: blur(15px);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-link {
            font-weight: 500;
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 0 5px;
        }
        
        .nav-link:hover, .nav-link.active {
            background: var(--glass-effect);
            transform: translateY(-2px);
        }
        
        /* تصميم الجدول المحسن */
        .table {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .table thead th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            border: none;
            padding: 15px 10px;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background: var(--glass-effect);
            transform: scale(1.01);
        }
        
        /* نظام الألوان المخصص للحالات */
        .status-accounted { background: var(--color-accounted) !important; color: #000 !important; }
        .status-mandob-accounted { background: var(--color-mandob-accounted) !important; color: #fff !important; }
        .status-customer-accounted { background: var(--color-customer-accounted) !important; color: #fff !important; }
        .status-delivered { background: var(--color-delivered) !important; color: #fff !important; }
        .status-rejected { background: var(--color-rejected) !important; color: #fff !important; }
        .status-partial-return { background: var(--color-partial-return) !important; color: #000 !important; }
        .status-delayed { background: var(--color-delayed) !important; color: #000 !important; }
        .status-in-progress { background: var(--color-in-progress) !important; color: #000 !important; }
        .status-unconfirmed { background: var(--color-unconfirmed) !important; color: #fff !important; }
        .status-partial-return-yellow { background: var(--color-partial-return-yellow) !important; color: #fff !important; }
        .status-partial-delivered { background: var(--color-partial-delivered) !important; color: #fff !important; }
        .status-warehouse-return { background: #8A2BE2 !important; color: #fff !important; }
        
        .badge {
            font-size: 0.8em;
            padding: 8px 12px;
            border-radius: 25px;
            font-weight: 600;
            text-transform: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        /* تحسينات للأزرار */
        .btn {
            border-radius: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        /* تحسينات للفلاتر */
        .form-control, .form-select {
            border-radius: 15px;
            border: 2px solid var(--glass-effect);
            background: var(--card-bg);
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        
        /* تحسينات للتنبيهات */
        .alert {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        /* تحسينات للمبالغ */
        .amount-display {
            font-weight: 700;
            color: #28a745;
            font-family: 'Courier New', monospace;
        }
        
        /* سبب التعليق */
        .suspension-reason {
            font-size: 0.9em;
            color: #dc3545;
            font-weight: 600;
            background: rgba(220, 53, 69, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        /* تأثيرات الحركة */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* تحسينات للأيقونات */
        .fas, .far {
            transition: all 0.3s ease;
        }
        
        .btn:hover .fas, .btn:hover .far {
            transform: scale(1.1);
        }
        
        /* تحسينات DataTables للهواتف */
        @media (max-width: 768px) {
            .dataTables_wrapper .dataTables_length,
            .dataTables_wrapper .dataTables_filter {
                text-align: center;
                margin-bottom: 10px;
            }
            
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate {
                text-align: center;
                margin-top: 10px;
            }
            
            .dataTables_wrapper .dataTables_paginate .paginate_button {
                padding: 5px 10px;
                margin: 2px;
                border-radius: 10px;
            }
        }
        
        /* تحسينات للفلاتر المتقدمة */
        .filter-section {
            background: var(--glass-effect);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- شريط التنقل المحسن -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-eye me-2"></i>
                سبونج إي
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i> الرئيسية</a>
                <a class="nav-link" href="/today_orders"><i class="fas fa-calendar-day me-1"></i> طلبات اليوم</a>
                <a class="nav-link" href="/customers"><i class="fas fa-users me-1"></i> العملاء</a>
                <a class="nav-link" href="/agent_commission"><i class="fas fa-money-bill-wave me-1"></i> حساب مستحق</a>
                <a class="nav-link" href="/isolated"><i class="fas fa-exclamation-triangle me-1"></i> المعزولة</a>
                <a class="nav-link active" href="/suspended"><i class="fas fa-clock me-1"></i> المعلقات</a>
                <a class="nav-link" href="/processed_orders"><i class="fas fa-check-circle me-1"></i> المعالجة</a>
                <a class="nav-link" href="/monitoring"><i class="fas fa-history me-1"></i> السجل</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="alert alert-warning slide-in">
            <h5><i class="fas fa-clock me-2"></i>تنبيه!</h5>
            <p class="mb-0">هذه الطلبات تحتاج إلى متابعة فورية بسبب مرور وقت طويل عليها.</p>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4 slide-in">
            <h2><i class="fas fa-clock me-2"></i>الطلبات المعلقة</h2>
            <div class="d-flex flex-wrap gap-2">
                <a href="/print_suspended_report" class="btn btn-primary btn-lg" target="_blank">
                    <i class="fas fa-print me-2"></i>
                    طباعة التقرير
                </a>
                <a href="/suspended" class="btn btn-warning btn-lg">
                    <i class="fas fa-clock me-2"></i>
                    كشف المعلقات
                </a>
            </div>
        </div>

        <!-- قسم الفلاتر المحسن -->
        <div class="card mb-4 slide-in">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>
                    فلترة البيانات المتقدمة
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label">البحث في النص:</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="ابحث في أي حقل...">
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label text-success fw-bold">
                            <i class="fas fa-check-circle me-1"></i>
                            تحديد الحالات:
                        </label>
                        <div class="filter-section">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="statusInProgress" value="قيد التنفيذ">
                            <label class="form-check-label" for="statusInProgress">قيد التنفيذ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="statusDelayed" value="مؤجل">
                            <label class="form-check-label" for="statusDelayed">مؤجل</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="statusRejected" value="رفض">
                            <label class="form-check-label" for="statusRejected">رفض</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="statusReturned" value="راجع مخزن">
                            <label class="form-check-label" for="statusReturned">راجع مخزن</label>
                        </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="statusDelivered" value="تم التسليم">
                                <label class="form-check-label" for="statusDelivered">تم التسليم</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="statusMandobAccounted" value="تم محاسبة المندوب">
                                <label class="form-check-label" for="statusMandobAccounted">تم محاسبة المندوب</label>
                            </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-success btn-sm me-1" onclick="selectAllStatuses()">
                                <i class="fas fa-check-double me-1"></i> تحديد الكل
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="clearAllStatuses()">
                                <i class="fas fa-times me-1"></i> مسح الكل
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label text-danger fw-bold">
                            <i class="fas fa-times-circle me-1"></i>
                            استبعاد الحالات:
                        </label>
                        <div class="filter-section">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeInProgress" value="قيد التنفيذ">
                            <label class="form-check-label" for="excludeInProgress">قيد التنفيذ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeDelayed" value="مؤجل">
                            <label class="form-check-label" for="excludeDelayed">مؤجل</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeRejected" value="رفض">
                            <label class="form-check-label" for="excludeRejected">رفض</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeReturned" value="راجع مخزن">
                            <label class="form-check-label" for="excludeReturned">راجع مخزن</label>
                        </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludeDelivered" value="تم التسليم">
                                <label class="form-check-label" for="excludeDelivered">تم التسليم</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludeMandobAccounted" value="تم محاسبة المندوب">
                                <label class="form-check-label" for="excludeMandobAccounted">تم محاسبة المندوب</label>
                            </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-danger btn-sm me-1" onclick="selectAllExclusions()">
                                <i class="fas fa-times-circle me-1"></i> استبعاد الكل
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllExclusions()">
                                <i class="fas fa-times me-1"></i> مسح الكل
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            سبب التعليق:
                        </label>
                        <select class="form-select" id="suspensionFilter">
                            <option value="">جميع الأسباب</option>
                            {% set suspension_reasons = orders | map(attribute='suspension_reason') | list | unique | sort %}
                            {% for reason in suspension_reasons %}
                                {% if reason %}
                                    <option value="{{ reason }}">{{ reason }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        </div>
                            </div>
                <div class="row">
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label">المبلغ:</label>
                        <select class="form-select" id="amountFilter">
                            <option value="">جميع المبالغ</option>
                            <option value="0-10000">أقل من 10,000</option>
                            <option value="10000-50000">10,000 - 50,000</option>
                            <option value="50000-100000">50,000 - 100,000</option>
                            <option value="100000+">أكثر من 100,000</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label">
                            <i class="fas fa-user me-1"></i>
                            المندوب:
                        </label>
                        <select class="form-select" id="mandobFilter">
                            <option value="">جميع المندوبين</option>
                            {% set mandobs = orders | map(attribute='mandob_name') | list | unique | sort %}
                            {% for mandob in mandobs %}
                                {% if mandob %}
                                    <option value="{{ mandob }}">{{ mandob }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label">
                            <i class="fas fa-users me-1"></i>
                            العميل:
                        </label>
                        <select class="form-select" id="customerFilter">
                            <option value="">جميع العملاء</option>
                            {% set customers = orders | map(attribute='customer_name') | list | unique | sort %}
                            {% for customer in customers %}
                                {% if customer %}
                                    <option value="{{ customer }}">{{ customer }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        </div>
                    <div class="col-lg-3 col-md-6 col-sm-12 mb-3">
                        <label class="form-label">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            المدينة:
                        </label>
                        <select class="form-select" id="cityFilter">
                            <option value="">جميع المدن</option>
                            {% set cities = orders | map(attribute='city') | list | unique | sort %}
                            {% for city in cities %}
                                {% if city %}
                                    <option value="{{ city }}">{{ city }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times me-1"></i>
                            مسح الفلاتر
                        </button>
                        <button class="btn btn-info" onclick="exportFilteredData()">
                            <i class="fas fa-download me-1"></i>
                            تصدير البيانات المفلترة
                        </button>
                        <a href="/print_suspended_report" class="btn btn-primary" target="_blank">
                            <i class="fas fa-print me-1"></i>
                            طباعة التقرير
                        </a>
                        <button class="btn btn-success" onclick="printFilteredData()">
                            <i class="fas fa-print me-1"></i>
                            طباعة المفلترة
                        </button>
                        <button class="btn btn-warning" onclick="showFilterStats()">
                            <i class="fas fa-chart-bar me-1"></i>
                            إحصائيات الفلترة
                        </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- جدول الطلبات المعلقة -->
        <div class="card slide-in">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>
                    الطلبات المعلقة - {{ orders|length }} طلب
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover w-100" id="suspendedTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>رقم الوصل</th>
                                <th>رقم الطلب</th>
                                <th>العميل</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>سبب التعليق</th>
                                <th>التاريخ</th>
                                <th>المدينة</th>
                                <th>المندوب</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td><strong>{{ loop.index }}</strong></td>
                                <td>{{ order.wasl_number }}</td>
                                <td>{{ order.order_number }}</td>
                                <td>{{ order.customer_name }}</td>
                                <td class="amount-display">{{ format_iraqi_dinar(order.total_amount) }}</td>
                                <td>
                                    <span class="badge" data-status="{{ order.status }}">
                                        {{ order.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="suspension-reason">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        {{ order.suspension_reason }}
                                    </span>
                                </td>
                                <td>{{ order.add_date }}</td>
                                <td>{{ order.city }}</td>
                                <td>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-user me-1"></i>
                                        {{ order.mandob_name or 'غير محدد' }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-info btn-sm me-1" 
                                            title="نسخ معلومات الطلب"
                                            onclick="copyOrderInfo(event, '{{ order.wasl_number }}', '{{ order.customer_name }}', '{{ format_iraqi_dinar(order.total_amount) }}', '{{ order.status }}', '{{ order.customer_phone }}', '{{ order.city }}', '{{ order.area }}', '{{ order.mandob_name }}')">
                                        <i class="fas fa-copy me-1"></i> نسخ
                                    </button>
                                    <a class="btn btn-secondary btn-sm me-1" 
                                       title="طباعة الوصل"
                                       href="https://alkarar-exp.com/print_waslAll.php?wasl_id={{ order.order_number }}" 
                                       target="_blank">
                                        <i class="fas fa-print me-1"></i> طباعة
                                    </a>
                                    {% if order.status.strip() in ['راجع مخزن', 'رفض'] %}
                                    <a href="/delete_order/{{ order.wasl_number }}" 
                                       class="btn btn-danger btn-sm" 
                                       title="حذف الطلب من النظام الخارجي"
                                       onclick="return confirm('هل أنت متأكد من حذف الطلب رقم {{ order.wasl_number }}؟')">
                                        <i class="fas fa-trash me-1"></i> حذف
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- تحميل المكتبات -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- تفعيل DataTables -->
    <script>
    $(document).ready(function() {
        // تفعيل DataTables مع إعدادات محسنة
        var table = $('#suspendedTable').DataTable({
            "paging": true,
            "lengthMenu": [10, 20, 30, 40, 50, 60, 70, 100],
            "pageLength": 20,
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/ar.json"
            },
            "ordering": true,
            "info": true,
            "searching": true,
            "responsive": true,
            "autoWidth": false,
            "columnDefs": [
                { "width": "5%", "targets": 0 },
                { "width": "10%", "targets": [1, 2] },
                { "width": "12%", "targets": 3 },
                { "width": "10%", "targets": 4 },
                { "width": "8%", "targets": 5 },
                { "width": "15%", "targets": 6 },
                { "width": "8%", "targets": [7, 8] },
                { "width": "10%", "targets": 9 },
                { "width": "12%", "targets": 10 }
            ],
            "drawCallback": function(settings) {
                // تطبيق نظام الألوان المخصص
                applyCustomStatusColors();
            }
        });
        
        // ربط الفلاتر بـ DataTable
        setupFilters(table);
        
        // تطبيق تأثيرات الحركة
        $('.slide-in').each(function(index) {
            $(this).delay(index * 100).queue(function(next) {
                $(this).addClass('slide-in');
                next();
            });
        });
        
        // تطبيق الألوان المخصصة عند تحميل الصفحة
        applyCustomStatusColors();
        
        // تحديث العداد عند تحميل الصفحة
        setTimeout(function() { updateFilterCounter(table); }, 500);
    });
    
    // إعداد الفلاتر
    function setupFilters(table) {
        // فلتر البحث النصي
        $('#searchInput').on('keyup', function() {
            table.search(this.value).draw();
            setTimeout(function() { updateFilterCounter(table); }, 100);
        });
        
        // فلتر سبب التعليق
        $('#suspensionFilter').on('change', function() {
            var value = this.value;
            if (value === '') {
                table.column(6).search('').draw();
            } else {
                table.column(6).search(value).draw();
            }
            setTimeout(function() { updateFilterCounter(table); }, 100);
        });
        
        // فلتر المندوب
        $('#mandobFilter').on('change', function() {
            var value = this.value;
            if (value === '') {
                table.column(9).search('').draw();
            } else {
                table.column(9).search(value).draw();
            }
            setTimeout(function() { updateFilterCounter(table); }, 100);
        });
        
        // فلتر العميل
        $('#customerFilter').on('change', function() {
            var value = this.value;
            if (value === '') {
                table.column(3).search('').draw();
            } else {
                table.column(3).search(value).draw();
            }
            setTimeout(function() { updateFilterCounter(table); }, 100);
        });
        
        // فلتر المدينة
        $('#cityFilter').on('change', function() {
            var value = this.value;
            if (value === '') {
                table.column(8).search('').draw();
            } else {
                table.column(8).search(value).draw();
            }
            setTimeout(function() { updateFilterCounter(table); }, 100);
        });
        
        // فلتر المبلغ
        $('#amountFilter').on('change', function() {
            var value = this.value;
            
            // إزالة فلتر المبلغ السابق
            $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(fn) {
                return fn.name !== 'amountFilter';
            });
            
            if (value !== '') {
                // إضافة فلتر مبلغ جديد
                var amountFilterFn = function(settings, data, dataIndex) {
                    if (settings.nTable.id !== 'suspendedTable') {
                        return true;
                    }
                    
                    var amountText = data[4]; // عمود المبلغ
                    var amount = parseFloat(amountText.replace(/[^\d]/g, ''));
                    
                    switch(value) {
                        case '0-10000':
                            return amount < 10000;
                        case '10000-50000':
                            return amount >= 10000 && amount <= 50000;
                        case '50000-100000':
                            return amount >= 50000 && amount <= 100000;
                        case '100000+':
                            return amount > 100000;
                        default:
                            return true;
                    }
                };
                amountFilterFn.name = 'amountFilter';
                $.fn.dataTable.ext.search.push(amountFilterFn);
            }
            
            table.draw();
            setTimeout(function() { updateFilterCounter(table); }, 100);
        });
        
        // فلاتر تحديد الحالات
        $('#statusInProgress, #statusDelayed, #statusRejected, #statusReturned, #statusDelivered, #statusMandobAccounted').on('change', function() {
            console.log('Status filter changed:', $(this).attr('id'), $(this).is(':checked'));
            applyStatusFilters(table);
        });
        
        // فلاتر استبعاد الحالات
        $('#excludeInProgress, #excludeDelayed, #excludeRejected, #excludeReturned, #excludeDelivered, #excludeMandobAccounted').on('change', function() {
            console.log('Exclude filter changed:', $(this).attr('id'), $(this).is(':checked'));
            applyStatusFilters(table);
        });
    }
    
    // تطبيق فلاتر الحالات
    function applyStatusFilters(table) {
        // الحصول على الحالات المحددة
        var includedStatuses = [];
        var excludedStatuses = [];
        
        if ($('#statusInProgress').is(':checked')) includedStatuses.push('قيد التنفيذ');
        if ($('#statusDelayed').is(':checked')) includedStatuses.push('مؤجل');
        if ($('#statusRejected').is(':checked')) includedStatuses.push('رفض');
        if ($('#statusReturned').is(':checked')) includedStatuses.push('راجع مخزن');
        if ($('#statusDelivered').is(':checked')) includedStatuses.push('تم التسليم');
        if ($('#statusMandobAccounted').is(':checked')) includedStatuses.push('تم محاسبة المندوب');
        
        if ($('#excludeInProgress').is(':checked')) excludedStatuses.push('قيد التنفيذ');
        if ($('#excludeDelayed').is(':checked')) excludedStatuses.push('مؤجل');
        if ($('#excludeRejected').is(':checked')) excludedStatuses.push('رفض');
        if ($('#excludeReturned').is(':checked')) excludedStatuses.push('راجع مخزن');
        if ($('#excludeDelivered').is(':checked')) excludedStatuses.push('تم التسليم');
        if ($('#excludeMandobAccounted').is(':checked')) excludedStatuses.push('تم محاسبة المندوب');
        
        console.log('Included statuses:', includedStatuses); // للتشخيص
        console.log('Excluded statuses:', excludedStatuses); // للتشخيص
        
        // إزالة فلتر الحالات السابق
        $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(fn) {
            return fn.name !== 'statusFilter';
        });
        
        // إضافة فلتر مخصص للحالات
        if (includedStatuses.length > 0 || excludedStatuses.length > 0) {
            var statusFilterFn = function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'suspendedTable') {
                    return true;
                }
                
                // طريقة متعددة للحصول على النص من الحالة
                var statusText = '';
                
                // الطريقة الأولى: من DOM
                try {
                    var row = $(settings.nTable).find('tbody tr').eq(dataIndex);
                    var statusCell = row.find('td:nth-child(6)'); // عمود الحالة (الفهرس 6)
                    statusText = statusCell.find('.badge').text().trim();
                } catch (e) {
                    console.log('DOM method failed, trying data method');
                }
                
                // الطريقة الثانية: من البيانات مباشرة
                if (!statusText) {
                    var status = data[5]; // عمود الحالة
                    if (typeof status === 'string') {
                        if (status.includes('<')) {
                            statusText = $(status).text().trim();
                        } else {
                            statusText = status.trim();
                        }
                    } else {
                        statusText = status.toString().trim();
                    }
                }
                
                console.log('Row', dataIndex, 'Status:', statusText); // للتشخيص
                
                // إذا كانت هناك حالات محددة للتضمين
                if (includedStatuses.length > 0) {
                    if (!includedStatuses.includes(statusText)) {
                        return false;
                    }
                }
                
                // إذا كانت هناك حالات محددة للاستبعاد
                if (excludedStatuses.length > 0) {
                    if (excludedStatuses.includes(statusText)) {
                        return false;
                    }
                }
                
                return true;
            };
            statusFilterFn.name = 'statusFilter';
            $.fn.dataTable.ext.search.push(statusFilterFn);
        }
        
        table.draw();
        
        // تحديث العداد بعد الفلترة
        setTimeout(function() {
            updateFilterCounter(table);
        }, 100);
    }
    
    // دالة تطبيق الألوان المخصصة للحالات
    function applyCustomStatusColors() {
        $('.badge').each(function() {
            const status = $(this).text().trim();
            $(this).removeClass('bg-success bg-warning bg-danger bg-primary bg-info bg-secondary');
            
            switch(status) {
                case 'تم المحاسبة':
                    $(this).addClass('status-accounted');
                    break;
                case 'تم محاسبة المندوب':
                    $(this).addClass('status-mandob-accounted');
                    break;
                case 'تم محاسبة العميل':
                    $(this).addClass('status-customer-accounted');
                    break;
                case 'تم التسليم':
                    $(this).addClass('status-delivered');
                    break;
                case 'رفض':
                    $(this).addClass('status-rejected');
                    break;
                case 'راجع جزئي':
                    $(this).addClass('status-partial-return-yellow');
                    break;
                case 'مؤجل':
                    $(this).addClass('status-delayed');
                    break;
                case 'قيد التنفيذ':
                    $(this).addClass('status-in-progress');
                    break;
                case 'غير مؤكد':
                    $(this).addClass('status-unconfirmed');
                    break;
                case 'واصل جزئي':
                    $(this).addClass('status-partial-delivered');
                    break;
                case 'راجع مخزن':
                    $(this).addClass('status-warehouse-return');
                    break;
                default:
                    $(this).addClass('status-unconfirmed');
            }
        });
    }
    </script>

    <!-- الكود الأصلي للوظائف -->
    <script>
        function copyOrderInfo(event, waslNumber, customerName, amount, status, phone, city, area, mandobName) {
            const orderInfo = `🧾 رقم الوصل: ${waslNumber}
🔴 هاتف الزبون: ${phone || 'غير محدد'}
🏢 المحافظة: ${city || 'غير محدد'}
🏢 المنطقة: ${area || 'غير محدد'}
🔴 السعر: ${amount}
📛 اسم العميل: ${customerName}
📊 الحالة: ${status}
👤 المندوب: ${mandobName || 'غير محدد'}`;
            
            navigator.clipboard.writeText(orderInfo).then(function() {
                // إظهار رسالة نجاح مع تأثيرات
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check me-1"></i> تم النسخ';
                button.className = 'btn btn-success btn-sm me-1';
                
                setTimeout(function() {
                    button.innerHTML = originalText;
                    button.className = 'btn btn-info btn-sm me-1';
                }, 2000);
            }).catch(function(err) {
                console.error('خطأ في النسخ: ', err);
                alert('خطأ في نسخ المعلومات');
            });
        }
        
        // دوال الفلترة المتقدمة
        function selectAllStatuses() {
            document.getElementById('statusInProgress').checked = true;
            document.getElementById('statusDelayed').checked = true;
            document.getElementById('statusRejected').checked = true;
            document.getElementById('statusReturned').checked = true;
            document.getElementById('statusDelivered').checked = true;
            document.getElementById('statusMandobAccounted').checked = true;
            
            // إشارة بصرية
            showFilterApplied();
            applyStatusFilters($('#suspendedTable').DataTable());
        }
        
        function clearAllStatuses() {
            document.getElementById('statusInProgress').checked = false;
            document.getElementById('statusDelayed').checked = false;
            document.getElementById('statusRejected').checked = false;
            document.getElementById('statusReturned').checked = false;
            document.getElementById('statusDelivered').checked = false;
            document.getElementById('statusMandobAccounted').checked = false;
            
            // إشارة بصرية
            showFilterCleared();
            applyStatusFilters($('#suspendedTable').DataTable());
        }
        
        function selectAllExclusions() {
            document.getElementById('excludeInProgress').checked = true;
            document.getElementById('excludeDelayed').checked = true;
            document.getElementById('excludeRejected').checked = true;
            document.getElementById('excludeReturned').checked = true;
            document.getElementById('excludeDelivered').checked = true;
            document.getElementById('excludeMandobAccounted').checked = true;
            applyStatusFilters($('#suspendedTable').DataTable());
        }
        
        function clearAllExclusions() {
            document.getElementById('excludeInProgress').checked = false;
            document.getElementById('excludeDelayed').checked = false;
            document.getElementById('excludeRejected').checked = false;
            document.getElementById('excludeReturned').checked = false;
            document.getElementById('excludeDelivered').checked = false;
            document.getElementById('excludeMandobAccounted').checked = false;
            applyStatusFilters($('#suspendedTable').DataTable());
        }
        
        function clearFilters() {
            var table = $('#suspendedTable').DataTable();
            
            // مسح البحث العام
            table.search('');
            
            // مسح البحث في الأعمدة
            table.columns().search('');
            
            // مسح الفلاتر المخصصة
            $.fn.dataTable.ext.search = [];
            
            // مسح قيم الحقول
            document.getElementById('searchInput').value = '';
            document.getElementById('suspensionFilter').value = '';
            document.getElementById('amountFilter').value = '';
            document.getElementById('mandobFilter').value = '';
            document.getElementById('customerFilter').value = '';
            document.getElementById('cityFilter').value = '';
            clearAllStatuses();
            clearAllExclusions();
            
            // إعادة رسم الجدول
            table.draw();
            setTimeout(function() { updateFilterCounter(table); }, 100);
        }
        
        function exportFilteredData() {
            const table = $('#suspendedTable').DataTable();
            const data = table.rows({ search: 'applied' }).data();
            
            let csv = 'رقم الوصل,رقم الطلب,العميل,المبلغ,الحالة,سبب التعليق,التاريخ,المدينة,المندوب\n';
            
            data.each(function(row) {
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'الطلبات_المعلقة_المفلترة.csv';
            link.click();
        }
        
        function printFilteredData() {
            window.print();
        }
        
        function showFilterStats() {
            const table = $('#suspendedTable').DataTable();
            const filteredData = table.rows({ search: 'applied' }).data();
            const totalFiltered = filteredData.length;
            const totalAll = table.rows().count();
            
            alert(`إحصائيات الفلترة:\nالطلبات المفلترة: ${totalFiltered}\nإجمالي الطلبات: ${totalAll}\nنسبة الفلترة: ${((totalFiltered/totalAll)*100).toFixed(1)}%`);
        }
        
        // دوال الإشارات البصرية
        function showFilterApplied() {
            // إضافة إشارة بصرية مؤقتة
            const alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                           '<i class="fas fa-filter me-2"></i>تم تطبيق الفلتر بنجاح!' +
                           '</div>');
            $('.container-fluid').prepend(alert);
            
            setTimeout(function() {
                alert.fadeOut(500, function() {
                    $(this).remove();
                });
            }, 2000);
        }
        
                 function showFilterCleared() {
             // إضافة إشارة بصرية مؤقتة
             const alert = $('<div class="alert alert-info alert-dismissible fade show" role="alert">' +
                            '<i class="fas fa-times me-2"></i>تم مسح الفلتر!' +
                            '</div>');
             $('.container-fluid').prepend(alert);
             
             setTimeout(function() {
                 alert.fadeOut(500, function() {
                     $(this).remove();
                 });
             }, 2000);
         }
         
         // تحديث عداد الطلبات المفلترة
         function updateFilterCounter(table) {
             const filteredCount = table.rows({ search: 'applied' }).count();
             const totalCount = table.rows().count();
             
             // تحديث عنوان البطاقة
             const cardTitle = $('.card-title');
             cardTitle.html(`<i class="fas fa-clock me-2"></i>الطلبات المعلقة - ${filteredCount} من ${totalCount} طلب`);
             
             // إضافة لون مختلف إذا كان هناك فلتر
             if (filteredCount < totalCount) {
                 cardTitle.addClass('text-primary');
                 // إضافة أيقونة فلتر
                 if (!cardTitle.find('.filter-icon').length) {
                     cardTitle.append(' <i class="fas fa-filter filter-icon text-success"></i>');
                 }
             } else {
                 cardTitle.removeClass('text-primary');
                 // إزالة أيقونة الفلتر
                 cardTitle.find('.filter-icon').remove();
             }
         }
    </script>
</body>
</html> 